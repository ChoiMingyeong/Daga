@using Microsoft.JSInterop
@using System.Numerics

<canvas @ref="_canvasRef" />

@code {
    private ElementReference _canvasRef;
    private IJSObjectReference? _canvasModule;

    private float x = 0f;
    private float y = 0f;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _canvasModule = await JS.InvokeAsync<IJSObjectReference>("import", "/_content/DagaBlazorEngine/js/canvas.js");
            await _canvasModule.InvokeVoidAsync("init");
            await Task.Run(StartRenderLoopAsync);
        }
    }

    private async Task StartRenderLoopAsync()
    {
        while (true)
        {
            x += 0.1f;
            y += 0.1f;
            x %= 100f;
            y %= 100f;

            if (_canvasModule is not null)
            {
                await _canvasModule.InvokeVoidAsync("drawBegin", _canvasRef);
                await _canvasModule.InvokeVoidAsync("drawFillRect", 100 + x, 100 + y, 200, 80, "blue");
                await _canvasModule.InvokeVoidAsync("drawStrokeRect", 0 + x, 0 + y, 100, 100);
                await _canvasModule.InvokeVoidAsync("drawEnd", _canvasRef);
            }

            await InvokeAsync(StateHasChanged);
            await Task.Delay(16); // 약 60fps (1000ms / 60 ≈ 16ms)
        }
    }
}