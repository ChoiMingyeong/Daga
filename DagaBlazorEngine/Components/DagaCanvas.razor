@using Microsoft.JSInterop
@using System.Numerics

<canvas @ref="_canvasRef" width="@CanvasWidth" height="@CanvasHeight" />

@code {
    private ElementReference _canvasRef;
    private DotNetObjectReference<DagaCanvas>? _dotNetRef;
    private IJSObjectReference? _screenSizeModule;
    private IJSObjectReference? _canvasModule;

    public int CanvasWidth { get; private set; }
    public int CanvasHeight { get; private set; }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            _screenSizeModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/_content/DagaBlazorEngine/js/screenHelper.js");
            _canvasModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/_content/DagaBlazorEngine/js/canvasHelper.js");
            await _screenSizeModule.InvokeVoidAsync("resizeCallback", _dotNetRef);
        }

        await UpdateAsync();
    }

    [JSInvokable]
    public async Task OnResize(ScreenSize screenSize)
    {
        CanvasWidth = (int)screenSize.X;
        CanvasHeight = (int)screenSize.Y;

        await UpdateAsync();
        await InvokeAsync(StateHasChanged);
    }

    public async Task UpdateAsync()
    {
        if (null == _canvasModule)
            return;

        // 캔버스 다시 그리기 로직
        await _canvasModule.InvokeVoidAsync("drawRectangle", _canvasRef, 0, 0, CanvasWidth/2, CanvasHeight/2);
    }

    public async ValueTask DisposeAsync()
    {
        _dotNetRef?.Dispose();
        if (_screenSizeModule is not null)
            await _screenSizeModule.DisposeAsync();
        if (_canvasModule is not null)
            await _canvasModule.DisposeAsync();
    }

    public class ScreenSize
    {
        public float X { get; set; }
        public float Y { get; set; }
    }
}
